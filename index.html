<!-- VueJS -->
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<!-- UIkit CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.16.13/dist/css/uikit.min.css" />

<!-- UIkit JS -->
<script src="https://cdn.jsdelivr.net/npm/uikit@3.16.13/dist/js/uikit.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/uikit@3.16.13/dist/js/uikit-icons.min.js"></script>

<div id="app">
    <div class="uk-container uk-margin-top">
        <table class="uk-table uk-table-hover uk-table-divider">
            <button class="uk-button uk-button-default uk-margin-small-right" type="button"
                uk-toggle="target: #modal">New Product</button>
            <thead>
                <tr>
                    <th v-for="header in headers" :key="header.key">${ header.title }</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="product in products" :key="product.id">
                    <td>${ product.name }</td>
                    <td>${ product.quantity }</td>
                    <td>${ product.price }</td>
                    <td>${ product.store?.name }</td>
                    <td>
                        <a href="#" class="uk-icon-link uk-margin-small-right" @click="editItem(product)"
                            uk-toggle="target: #modal" uk-icon="pencil"></a>
                        <a href="#" class="uk-icon-link" @click="deleteItem(product)" uk-icon="trash"></a>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Modal -->
    <div id="modal" uk-modal>
        <div class="uk-modal-dialog uk-modal-body">
            <h2 class="uk-modal-title">${ formTitle }</h2>
            <form class="uk-grid-small" uk-grid>
                <div class="uk-width-1-1">
                    <input class="uk-input" v-model="editedItem.name" type="text" placeholder="Name" aria-label="Name">
                </div>
                <div class="uk-width-1-4@s">
                    <input class="uk-input" v-model="editedItem.quantity" type="text" placeholder="Quantity"
                        aria-label="Quantity">
                </div>
                <div class="uk-width-1-4@s">
                    <input class="uk-input" v-model="editedItem.price" type="text" placeholder="Price"
                        aria-label="Price">
                </div>
                <div class="uk-width-1-2@s">
                    <input class="uk-input" v-model="editedItem.store.name" type="text" placeholder="Store"
                        aria-label="Store">
                </div>
            </form>
            <p class="uk-text-right">
                <button class="uk-button uk-button-default uk-modal-close uk-margin-small-right"
                    type="button">Cancel</button>
                <button class="uk-button uk-button-primary" type="button">Save</button>
            </p>
        </div>
    </div>
</div>

<script>
    const { ref, computed, watch, onMounted, nextTick, createApp } = Vue

    createApp({
        delimiters: ['${', '}'],
        setup() {
            const dialog = ref(false);
            const dialogDelete = ref(false);
            const headers = [
                {
                    title: "Name",
                    align: "start",
                    sortable: false,
                    key: "name",
                },
                { title: "Quantity", key: "quantity" },
                { title: "Price", key: "price" },
                { title: "Store", key: "store" },
                { title: "Actions", key: "actions", sortable: false },
            ];
            const products = ref([]);
            const editedIndex = ref(-1);
            const editedItem = ref({
                id: "",
                name: "",
                quantity: 0,
                price: 0.0,
                store: {
                    id: "",
                    name: ""
                },
            });
            const defaultItem = ref({
                id: "",
                name: "",
                quantity: 0,
                price: 0.0,
                store: {
                    id: "",
                    name: ""
                },
            });

            const formTitle = computed(() => {
                return editedIndex.value === -1 ? "New Product" : "Edit Product";
            });

            watch([dialog, dialogDelete], ([val, valDel]) => {
                dialog.value = val;
                dialogDelete.value = valDel;
            });

            onMounted(() => {
                initialize();
            });

            const initialize = () => {
                console.log("init");
            };

            const editItem = (item) => {
                editedIndex.value = products.value.indexOf(item);
                editedItem.value = Object.assign({}, item);
                dialog.value = true;
            };

            const deleteItem = (item) => {
                editedIndex.value = products.value.indexOf(item);
                editedItem.value = Object.assign({}, item);
                dialogDelete.value = true;
                UIkit.modal.confirm('Are you sure you want to delete this item?').then(function () {
                    console.log(`Confirmed deletion of: ${item.name}`)
                }, function () {
                    console.log(`Rejected deletion of: ${item.name}`)
                });
            };

            const deleteItemConfirm = () => {
                products.value.splice(editedIndex.value, 1);
                closeDelete();
            };

            const close = () => {
                dialog.value = false;
                nextTick(() => {
                    editedItem.value = Object.assign({}, defaultItem.value);
                    editedIndex.value = -1;
                });
            };

            const closeDelete = () => {
                dialogDelete.value = false;
                nextTick(() => {
                    editedItem.value = Object.assign({}, defaultItem.value);
                    editedIndex.value = -1;
                });
            };

            const save = () => {
                if (editedIndex.value > -1) {
                    Object.assign(products.value[editedIndex.value], editedItem.value);
                } else {
                    products.value.push(editedItem.value);
                }
                close();
            };

            fetch('/api/v1/products').then((response) => response.json()).then((data) => {
                products.value = data
            });

            return {
                dialog,
                dialogDelete,
                headers,
                products,
                editedIndex,
                editedItem,
                defaultItem,
                formTitle,
                initialize,
                editItem,
                deleteItem,
                deleteItemConfirm,
                close,
                closeDelete,
                save
            }
        }
    }).mount('#app')
</script>